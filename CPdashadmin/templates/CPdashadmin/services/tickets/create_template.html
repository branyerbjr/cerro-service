{% extends 'CPdashadmin/base_admin.html' %}

{% block admin_title %}Crear Nueva Plantilla{% endblock %}

{% block content_title %}Crear Nueva Plantilla{% endblock %}
{% block content_subtitle %}Definir una nueva plantilla de formulario para tickets{% endblock %}

{% block admin_content %}
<!-- Breadcrumb -->
<nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb">
        <li class="breadcrumb-item">
            <a href="{% url 'CPdashadmin:dashboard' %}">
                <i class="bi bi-house"></i> Dashboard
            </a>
        </li>
        <li class="breadcrumb-item">
            <a href="{% url 'CPdashadmin:ticket_categories_management' %}">
                <i class="bi bi-folder"></i> Categorías
            </a>
        </li>
        <li class="breadcrumb-item">
            <a href="{% url 'CPdashadmin:create_ticket_category' %}">
                <i class="bi bi-file-earmark-text"></i> Plantillas
            </a>
        </li>
        <li class="breadcrumb-item active" aria-current="page">
            <i class="bi bi-plus-circle"></i> Nueva Plantilla
        </li>
    </ol>
</nav>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-file-earmark-plus me-2"></i>
                    Información de la Plantilla
                </h5>
            </div>
            <div class="card-body">
                <form id="createTemplateForm">
                    {% csrf_token %}
                    
                    <!-- Nombre de la plantilla -->
                    <div class="mb-3">
                        <label for="templateName" class="form-label">
                            <i class="bi bi-tag me-2"></i>Nombre de la Plantilla *
                        </label>
                        <input type="text" class="form-control" id="templateName" required 
                               placeholder="Ej: Formulario de Mantenimiento, Consulta General">
                        <div class="form-text">Nombre descriptivo para identificar la plantilla</div>
                    </div>

                    <!-- Categoría -->
                    <div class="mb-3">
                        <label for="templateCategory" class="form-label">
                            <i class="bi bi-folder me-2"></i>Categoría *
                        </label>
                        <select class="form-select" id="templateCategory" required>
                            <option value="">Seleccionar categoría</option>
                            {% for category in categories %}
                                <option value="{{ category.id }}" {% if request.GET.category_id == category.id|stringformat:"s" %}selected{% endif %}>
                                    {{ category.name }}
                                </option>
                            {% endfor %}
                        </select>
                        <div class="form-text">Categoría a la que pertenece esta plantilla</div>
                    </div>

                    <!-- Subcategoría -->
                    <div class="mb-3">
                        <label for="templateSubcategory" class="form-label">
                            <i class="bi bi-tags me-2"></i>Subcategoría
                        </label>
                        <select class="form-select" id="templateSubcategory">
                            <option value="">Seleccionar subcategoría (opcional)</option>
                        </select>
                        <div class="form-text">Subcategoría específica (opcional)</div>
                    </div>

                    <!-- Tema -->
                    <div class="mb-3">
                        <label for="templateTheme" class="form-label">
                            <i class="bi bi-palette me-2"></i>Tema
                        </label>
                        <select class="form-select" id="templateTheme">
                            <option value="default">Tema Predeterminado</option>
                            <option value="modern">Tema Moderno</option>
                            <option value="classic">Tema Clásico</option>
                            <option value="minimal">Tema Minimalista</option>
                        </select>
                        <div class="form-text">Tema visual para el formulario</div>
                    </div>

                    <!-- Estado -->
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="bi bi-toggle-on me-2"></i>Estado
                        </label>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="templateActive" checked>
                            <label class="form-check-label" for="templateActive">
                                Plantilla activa
                            </label>
                        </div>
                        <div class="form-text">Las plantillas inactivas no aparecerán en los kiosks</div>
                    </div>

                    <!-- Botones -->
                    <div class="d-flex justify-content-between">
                        <a href="{% url 'CPdashadmin:ticket_categories_management' %}" class="btn btn-secondary">
                            <i class="bi bi-arrow-left me-2"></i>Cancelar
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle me-2"></i>Crear Plantilla
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <!-- Vista previa -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-eye me-2"></i>Vista Previa
                </h5>
            </div>
            <div class="card-body">
                <div class="template-preview">
                    <div class="preview-item">
                        <i class="bi bi-file-earmark-text"></i>
                        <span id="previewName">Nombre de la plantilla</span>
                    </div>
                    <div class="preview-details">
                        <small class="text-muted">
                            <strong>Categoría:</strong> <span id="previewCategory">Sin seleccionar</span><br>
                            <strong>Tema:</strong> <span id="previewTheme">Predeterminado</span><br>
                            <strong>Estado:</strong> <span id="previewStatus">Activa</span>
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Información -->
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-info-circle me-2"></i>Información
                </h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <h6><i class="bi bi-lightbulb me-2"></i>Consejos:</h6>
                    <ul class="mb-0">
                        <li>Usa nombres claros y descriptivos</li>
                        <li>Selecciona la categoría correcta</li>
                        <li>Los temas afectan la apariencia del formulario</li>
                        <li>Puedes desactivar plantillas sin eliminarlas</li>
                    </ul>
                </div>
                
                <div class="alert alert-warning">
                    <h6><i class="bi bi-exclamation-triangle me-2"></i>Nota:</h6>
                    <p class="mb-0">Una vez creada la plantilla, podrás agregar campos de formulario personalizados.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de confirmación -->
<div class="modal fade" id="successModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-check-circle text-success me-2"></i>
                    Plantilla Creada
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>La plantilla ha sido creada exitosamente.</p>
                <div id="templateInfo">
                    <!-- Información de la plantilla creada -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <a href="{% url 'CPdashadmin:ticket_categories_management' %}" class="btn btn-primary">Ver Plantillas</a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
{{ block.super }}
<style>
    .breadcrumb {
        background: var(--neutral-light);
        border-radius: 10px;
        padding: 1rem 1.5rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .breadcrumb-item a {
        color: var(--primary-dark);
        text-decoration: none;
    }
    
    .breadcrumb-item.active {
        color: var(--neutral-gray);
    }
    
    .card {
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        border: 1px solid rgba(0,0,0,0.05);
    }
    
    .card-header {
        background: linear-gradient(135deg, var(--primary-light) 0%, var(--primary-dark) 100%);
        color: var(--neutral-light);
        border-radius: 15px 15px 0 0 !important;
        border: none;
    }
    
    .form-label {
        font-weight: 600;
        color: var(--primary-dark);
        margin-bottom: 0.5rem;
    }
    
    .form-control, .form-select {
        border-radius: 10px;
        border: 2px solid var(--neutral-gray);
        transition: all 0.3s ease;
        padding: 0.75rem 1rem;
    }
    
    .form-control:focus, .form-select:focus {
        border-color: var(--primary-dark);
        box-shadow: 0 0 0 0.2rem rgba(var(--primary-dark-rgb), 0.25);
        transform: translateY(-1px);
    }
    
    .form-check-input:checked {
        background-color: var(--primary-dark);
        border-color: var(--primary-dark);
    }
    
    .btn {
        border-radius: 10px;
        font-weight: 600;
        transition: all 0.3s ease;
        padding: 0.75rem 1.5rem;
    }
    
    .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    
    .alert {
        border-radius: 10px;
        border: none;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .template-preview {
        background: var(--neutral-light);
        border-radius: 10px;
        padding: 1.5rem;
        border: 2px dashed var(--neutral-gray);
    }
    
    .preview-item {
        display: flex;
        align-items: center;
        gap: 1rem;
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 1rem;
    }
    
    .preview-item i {
        font-size: 1.5rem;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        background: var(--primary-light);
        color: var(--neutral-light);
    }
    
    .preview-details {
        padding-left: 3rem;
    }
    
    .form-text {
        color: var(--neutral-gray);
        font-size: 0.85rem;
        margin-top: 0.25rem;
    }
</style>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
// Actualizar vista previa en tiempo real
document.getElementById('templateName').addEventListener('input', function() {
    document.getElementById('previewName').textContent = this.value || 'Nombre de la plantilla';
});

document.getElementById('templateCategory').addEventListener('change', function() {
    const categoryId = this.value;
    const categoryName = this.options[this.selectedIndex].text;
    document.getElementById('previewCategory').textContent = categoryName || 'Sin seleccionar';
    
    // Cargar subcategorías si hay una categoría seleccionada
    if (categoryId) {
        loadSubcategories(categoryId);
    } else {
        // Limpiar subcategorías
        const subcategorySelect = document.getElementById('templateSubcategory');
        subcategorySelect.innerHTML = '<option value="">Seleccionar subcategoría (opcional)</option>';
    }
});

document.getElementById('templateTheme').addEventListener('change', function() {
    const themeName = this.options[this.selectedIndex].text;
    document.getElementById('previewTheme').textContent = themeName;
});

document.getElementById('templateActive').addEventListener('change', function() {
    const status = this.checked ? 'Activa' : 'Inactiva';
    document.getElementById('previewStatus').textContent = status;
});

// Cargar subcategorías
function loadSubcategories(categoryId) {
    fetch(`{% url 'CPdashadmin:get_subcategories' 0 %}`.replace('0', categoryId), {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const subcategorySelect = document.getElementById('templateSubcategory');
            subcategorySelect.innerHTML = '<option value="">Seleccionar subcategoría (opcional)</option>';
            
            data.subcategories.forEach(subcategory => {
                const option = document.createElement('option');
                option.value = subcategory.id;
                option.textContent = subcategory.name;
                subcategorySelect.appendChild(option);
            });
        }
    })
    .catch(error => {
        console.error('Error:', error);
    });
}

// Manejar envío del formulario
document.getElementById('createTemplateForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = {
        name: document.getElementById('templateName').value,
        category_id: document.getElementById('templateCategory').value,
        subcategory_id: document.getElementById('templateSubcategory').value || null,
        theme: document.getElementById('templateTheme').value,
        is_active: document.getElementById('templateActive').checked
    };
    
    // Validaciones
    if (!formData.name.trim()) {
        showNotification('El nombre de la plantilla es requerido', 'warning');
        return;
    }
    
    if (!formData.category_id) {
        showNotification('Debes seleccionar una categoría', 'warning');
        return;
    }
    
    // Enviar datos
    fetch('{% url "CPdashadmin:create_ticket_template" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Mostrar modal de éxito
            const templateInfo = document.getElementById('templateInfo');
            templateInfo.innerHTML = `
                <div class="alert alert-success">
                    <strong>Nombre:</strong> ${data.template.name}<br>
                    <strong>Tema:</strong> ${data.template.theme}<br>
                    <strong>Estado:</strong> ${data.template.is_active ? 'Activa' : 'Inactiva'}<br>
                    <strong>Fecha:</strong> ${new Date(data.template.created_at).toLocaleString()}
                </div>
            `;
            
            const successModal = new bootstrap.Modal(document.getElementById('successModal'));
            successModal.show();
        } else {
            showNotification('Error: ' + data.message, 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error al crear la plantilla', 'danger');
    });
});

function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        <i class="bi bi-${type === 'info' ? 'info-circle' : type === 'warning' ? 'exclamation-triangle' : type === 'danger' ? 'x-circle' : 'check-circle'} me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}
</script>
{% endblock %}
